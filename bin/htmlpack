#!/usr/bin/env node

var HtmlMinifier = require('html-minifier');
var LzString = require('lz-string');
var args = process.argv.slice(2);

if (args.length > 1) {
  console.log('Usage: htmlpack [filename.html]');
  process.exit(0);
}
if (args.length == 1) {
  var fs = require('fs');
  fs.readFile(args[0], 'utf-8', function(err, data) {
    if (err) throw err;
    dopack(data);
  });
} else {
  var data = '';
  process.stdin.resume();
  process.stdin.setEncoding('utf-8');
  process.stdin.on('data', function(buf) { data += buf.toString(); });
  process.stdin.on('end', function() {
    dopack(data);
  });
}


function dopack(text) {
  var minified = HtmlMinifier.minify(text, {
    html5: true,
    collapseWhitespace: true,
    conservativeCollapse: true,
    minifyJS: { mangle: { toplevel: true } },
    removeComments: true,
    keepClosingSlash: true,
    removeAttributeQuotes: true
  });
  var prefix = minified.match(
    /^(?:\s*<!doctype\s*html\s*>)?(?:\s*<html[^>]*>)?(?:\s*<head[^>]*>)?/);
  prefix = prefix ? prefix[0] : '';
  compressed = LzString.compressToBase64(minified.substr(prefix.length));
  process.stdout.write('<script>/*' + compressed + '*/' +
  '!function(){function r(r,e,t){var a,c,n,o,i,v,f,s,h=[],u=4,m=4,b=3,l="",k=[],w=Math.pow,A={v:t(0),p:e,i:1};for(c=0;3>c;c+=1)h[c]=c;for(o=0,v=w(2,2),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;switch(a=o){case 0:for(o=0,v=w(2,8),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;s=p(o);break;case 1:for(o=0,v=w(2,16),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;s=p(o);break;case 2:return""}for(h[3]=s,n=s,k.push(s);;){if(A.i>r)return"";for(o=0,v=w(2,b),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;switch(s=o){case 0:for(o=0,v=w(2,8),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;h[m++]=p(o),s=m-1,u--;break;case 1:for(o=0,v=w(2,16),f=1;f!=v;)i=A.v&A.p,A.p>>=1,0==A.p&&(A.p=e,A.v=t(A.i++)),o|=(i>0?1:0)*f,f<<=1;h[m++]=p(o),s=m-1,u--;break;case 2:return k.join("")}0==u&&(u=w(2,b),b++),h[s]?l=h[s]:s===m&&(l=n+n.charAt(0)),k.push(l),h[m++]=n+l.charAt(0),u--,n=l,0==u&&(u=w(2,b),b++)}}for(var p=String.fromCharCode,e=document.scripts[0],t=e.text.substr(2).replace(/\\*.*$/,""),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c={},n=0;n<a.length;n++)c[a.charAt(n)]=n;e.parentElement.removeChild(e),document.write(r(t.length,32,function(r){return c[t.charAt(r)]}))}();</script>');
}

